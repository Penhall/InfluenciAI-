# 08.1 - Pipeline CI/CD

## Visão Geral

O projeto utiliza **GitHub Actions** para automação de CI/CD com os seguintes pipelines:

1. **CI/CD Principal** (`ci.yml`) - Build, teste e deploy
2. **Validação de PR** (`pr.yml`) - Validação rápida de pull requests
3. **CodeQL** (`codeql.yml`) - Análise de segurança
4. **Dependabot** - Atualizações automáticas de dependências

## Pipeline CI/CD Principal

**Arquivo:** `.github/workflows/ci.yml`

### Triggers

- Push para `main` ou `develop`
- Pull requests para `main` ou `develop`
- Execução manual (`workflow_dispatch`)

### Jobs

#### 1. Build & Test

**Ambiente:**
- OS: Ubuntu Latest
- .NET: 9.0.x
- Services: PostgreSQL 15, Redis 7

**Steps:**
1. Checkout do código
2. Setup do .NET SDK
3. Cache de pacotes NuGet
4. Restore de dependências
5. Build (Release)
6. Testes unitários com cobertura
7. Publicação dos resultados
8. Upload de artefatos

**Variáveis de ambiente para testes:**
```yaml
ConnectionStrings__DefaultConnection: "Host=localhost;Port=5432;..."
Jwt__Key: "test-jwt-key-for-ci-pipeline-..."
Redis__ConnectionString: "localhost:6379"
Seed__Admin__Password: "Test!1234"
```

#### 2. Code Quality Checks

**Verificações:**
- Vulnerabilidades em pacotes NuGet
- Formatação de código (`dotnet format`)
- Security scan

#### 3. Build Docker (somente main/develop)

**Ações:**
- Build da imagem Docker da API
- Cache de layers
- Extração de metadados (tags, labels)

#### 4. Release Notes (somente main)

**Ações:**
- Geração automática de changelog
- Upload como artefato

### Artefatos Gerados

- **build-artifacts** (7 dias de retenção)
  - API binaries (Release)
  - Desktop binaries (Release)
- **test-results**
  - Arquivos .trx com resultados dos testes
- **coverage**
  - Relatórios de cobertura de código
- **changelog**
  - Notas de release geradas

## Pipeline de Validação de PR

**Arquivo:** `.github/workflows/pr.yml`

### Objetivo

Validação rápida antes de merge, com feedback direto no PR.

### Features

1. **Build & Test Rápido**
   - Sem geração de artefatos
   - Foco em feedback rápido

2. **Code Format Check**
   - Verifica se código está formatado
   - Não bloqueia o PR (warning)

3. **Comentário Automático**
   - Resultado do build
   - Link para workflow completo

4. **Label por Tamanho**
   - `size/xs` (< 10 linhas)
   - `size/s` (< 100 linhas)
   - `size/m` (< 500 linhas)
   - `size/l` (< 1000 linhas)
   - `size/xl` (> 1000 linhas)

## Pipeline CodeQL

**Arquivo:** `.github/workflows/codeql.yml`

### Objetivo

Análise de segurança estática do código C#.

### Execução

- Push para main/develop
- Pull requests
- Semanalmente (segunda-feira às 8h UTC)

### Análises

- Vulnerabilidades conhecidas
- Code smells de segurança
- Injeções (SQL, XSS, etc)
- Uso inseguro de APIs

## Dependabot

**Arquivo:** `.github/dependabot.yml`

### Ecossistemas Monitorados

1. **NuGet Packages**
   - Atualização semanal (segunda-feira 9h)
   - Limite: 10 PRs abertos simultaneamente
   - Labels: `dependencies`, `nuget`

2. **GitHub Actions**
   - Atualização semanal
   - Labels: `dependencies`, `github-actions`

3. **Docker Images**
   - Atualização semanal
   - Labels: `dependencies`, `docker`

### Configuração

- **Reviewers:** Definir no arquivo
- **Assignees:** Definir no arquivo
- **Commit prefix:** `chore(deps)`

## Badges do README

Adicione ao `README.md`:

```markdown
[![CI/CD Pipeline](https://github.com/seu-usuario/InfluenciAI/actions/workflows/ci.yml/badge.svg)](https://github.com/seu-usuario/InfluenciAI/actions/workflows/ci.yml)
[![CodeQL](https://github.com/seu-usuario/InfluenciAI/actions/workflows/codeql.yml/badge.svg)](https://github.com/seu-usuario/InfluenciAI/actions/workflows/codeql.yml)
[![codecov](https://codecov.io/gh/seu-usuario/InfluenciAI/branch/main/graph/badge.svg)](https://codecov.io/gh/seu-usuario/InfluenciAI)
```

## Secrets Necessários

### Repository Secrets

Configure em: `Settings` → `Secrets and variables` → `Actions`

| Secret | Descrição | Obrigatório |
|--------|-----------|-------------|
| `CODECOV_TOKEN` | Token do Codecov.io | Opcional |
| `DOCKER_USERNAME` | Usuario Docker Hub | Se usar Docker push |
| `DOCKER_PASSWORD` | Senha Docker Hub | Se usar Docker push |
| `AZURE_CREDENTIALS` | Credenciais Azure | Para deploy Azure |

### Environment Variables

Já configuradas no workflow, não precisam de setup:

- `DOTNET_VERSION`
- `DOTNET_SKIP_FIRST_TIME_EXPERIENCE`
- `DOTNET_CLI_TELEMETRY_OPTOUT`

## Quality Gates

### Critérios de Sucesso

- ✅ Build com sucesso (Release)
- ✅ Todos os testes passam
- ⚠️ Cobertura de código > 60% (warning)
- ⚠️ Código formatado corretamente (warning)
- ✅ Sem vulnerabilidades críticas

### Falhas que Bloqueiam

- ❌ Erro de compilação
- ❌ Teste falhando
- ❌ Vulnerabilidade crítica detectada

### Avisos (Não Bloqueiam)

- ⚠️ Cobertura abaixo de 60%
- ⚠️ Código não formatado
- ⚠️ Vulnerabilidade baixa/média

## Performance

### Cache Strategy

1. **NuGet Packages**
   - Key: `${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}`
   - Invalidado quando .csproj mudam

2. **Docker Layers**
   - GitHub Actions Cache
   - Modo: `type=gha,mode=max`

### Tempos Esperados

- **Build & Test:** ~3-5 minutos
- **Code Quality:** ~2-3 minutos
- **Docker Build:** ~5-7 minutos
- **Total:** ~10-15 minutos

## Troubleshooting

### Erro: "Tests failed"

**Verificar:**
1. Testes passam localmente?
2. PostgreSQL/Redis rodando nos services?
3. Variáveis de ambiente configuradas?

**Solução:**
```bash
# Rodar testes localmente com mesmas env vars do CI
export ConnectionStrings__DefaultConnection="Host=localhost;..."
export Jwt__Key="test-jwt-key..."
dotnet test
```

### Erro: "Cache restore failed"

**Causa:** Mudança drástica em dependências

**Solução:** Workflow continua, apenas mais lento na primeira vez

### Erro: "CodeQL analysis failed"

**Causa:** Possível erro de compilação ou código problemático

**Solução:**
1. Verificar warnings do compilador
2. Corrigir problemas de segurança apontados

### Erro: "Docker build out of disk space"

**Solução:** GitHub Actions tem limite de 14GB
- Otimizar Dockerfile
- Usar multi-stage builds
- Limpar arquivos desnecessários

## Best Practices

### Pull Requests

1. Aguardar ✅ verde antes de merge
2. Resolver todos os warnings
3. Manter PRs pequenos (< 500 linhas)
4. Adicionar testes para novas features

### Commits

1. Usar conventional commits:
   - `feat:` Nova funcionalidade
   - `fix:` Correção de bug
   - `chore:` Manutenção
   - `docs:` Documentação
   - `test:` Testes

2. Commits pequenos e focados
3. Mensagens descritivas

### Branches

- `main` - Produção (protegida)
- `develop` - Desenvolvimento (protegida)
- `feature/*` - Features
- `fix/*` - Correções
- `chore/*` - Manutenção

### Code Review

- Mínimo 1 aprovação
- CI verde obrigatório
- Resolver todos os comentários
- Atualizar documentação se necessário

## Monitoramento

### GitHub Actions Dashboard

Acesse: `https://github.com/seu-usuario/InfluenciAI/actions`

**Visualizações:**
- Histórico de runs
- Duração dos jobs
- Taxa de sucesso/falha
- Logs detalhados

### Codecov Dashboard

Acesse: `https://codecov.io/gh/seu-usuario/InfluenciAI`

**Métricas:**
- Cobertura total
- Cobertura por arquivo
- Tendência ao longo do tempo
- Diff coverage em PRs

## Roadmap CI/CD

### Próximas Melhorias

1. **Deploy Automático**
   - Staging após merge em `develop`
   - Production após tag/release

2. **Testes E2E**
   - Playwright/Selenium
   - Screenshots em caso de falha

3. **Performance Tests**
   - Load testing com k6
   - Benchmarks automáticos

4. **Notificações**
   - Slack/Discord em falhas
   - Email para maintainers

5. **Ambientes de Preview**
   - Deploy temporário para cada PR
   - URL única para testes

## Referências

- [GitHub Actions Documentation](https://docs.github.com/actions)
- [.NET CI/CD Best Practices](https://learn.microsoft.com/dotnet/devops/)
- [CodeQL for C#](https://codeql.github.com/docs/codeql-language-guides/codeql-for-csharp/)
