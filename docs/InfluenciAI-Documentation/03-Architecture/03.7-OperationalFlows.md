# Fluxos Operacionais (Mermaid)

Este documento descreve, via diagramas Mermaid, os fluxos principais do backend: autenticação (Identity + JWT), CORS dinâmico e health/readiness (HealthChecks + UI).

## Autenticação (Login) e Autorização

```mermaid
flowchart TD
    A[Client] -->|POST /auth/login\n{ email, password }| B[API Login]
    B --> C[Identity UserManager\nFindByEmail + CheckPassword]
    C -->|válido| D[Cria JWT\nclaims: sub, name, tenant, role*]
    C -->|inválido| X[401 Unauthorized]
    D --> E[200 { access_token }]

    E --> F[Requisição protegida\nAuthorization: Bearer]
    F --> G[JWT Bearer Validation]
    G --> H[Authorization Policy\nTenantAdmin]
    H --> I{tenant claim ==\nroute tenantId?}
    I -- sim --> J[Executa endpoint minimal]
    I -- não --> K[403 Forbid]
```

Notas:
- Roles são incluídas no token (ClaimTypes.Role) e avaliadas pela policy `TenantAdmin`.
- Match do claim `tenant` com `tenantId` do path é exigido nos endpoints de usuários por tenant.

## CORS Dinâmico por Tenant

```mermaid
flowchart TD
    A[Browser] -->|Preflight/Origin| B[Kestrel + CORS]
    B --> C[TenantCorsPolicyProvider]
    C -->|AllowAllInDev = true\n(e Dev)| D[Permite qualquer origem]
    C -->|Header X-Tenant-Id| E[Lê Cors:Tenants:{id}:AllowedOrigins]
    C -->|Sem override| F[Usa Cors:AllowedOrigins]
    D --> G[Resposta CORS OK]
    E --> G
    F --> G
```

Notas:
- Header `X-Tenant-Id` permite sobrescrever origins por tenant em produção.
- Em desenvolvimento, `Cors.AllowAllInDev = true` facilita DX.

## Health / Readiness + UI

```mermaid
flowchart TD
    Admin[Operação] -->|GET /health/ui| UI[HealthChecks UI]
    UI -->|GET /health/ready| HC[HealthChecks Middleware]
    HC --> P[PostgreSQL]
    HC --> R[Redis]
    HC --> Q[RabbitMQ (TCP check)]
    P --> HC
    R --> HC
    Q --> HC
    HC -->|JSON UIResponse\n(status, entries)| UI
```

Notas:
- `/health/live` verifica liveness; `/health/ready` agrega dependências (PostgreSQL, Redis e RabbitMQ via verificação TCP).
- UI é exposta em `/health/ui` e consome `/health/ready`.
